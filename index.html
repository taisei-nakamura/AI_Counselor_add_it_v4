<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心の相談室</title>
    <meta name="description" content="AIカウンセラーがあなたの不安や悩みに寄り添い、専門家の知見に基づいたアドバイスを提供します。匿名で安心して相談できる心の相談室です。">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 20px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .chat-bubble-ai {
            background-color: #f1f5f9;
            color: #1e293b;
            border-bottom-left-radius: 4px;
        }
        .chat-bubble-user {
            background-color: #3b82f6;
            color: #ffffff;
            border-bottom-right-radius: 4px;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Modals */
        .modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .setting-option, .topic-option {
            transition: background-color 0.2s;
        }
        .setting-option.selected {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: 600;
        }
        /* Disabled button and input style */
        button:disabled, textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-teal-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl h-[90vh] sm:h-[85vh] bg-white rounded-2xl shadow-xl flex flex-col">
        <header class="bg-blue-500 text-white p-4 rounded-t-2xl shadow-md flex justify-between items-center">
            <div class="w-8"></div> <!-- Spacer -->
            <h1 id="header-title" class="text-xl font-bold text-center">心の相談室</h1>
            <button id="settings-button" class="p-2 rounded-full hover:bg-blue-600 transition-colors" title="設定">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </header>

        <main id="chat-container" class="flex-1 p-6 overflow-y-auto space-y-6">
            <!-- Chat messages will be appended here -->
        </main>

        <footer id="form-footer" class="p-4 bg-white border-t border-gray-200 rounded-b-2xl">
            <div id="loading-indicator" class="hidden text-center mb-2">
                <div class="flex justify-center items-center space-x-2">
                    <div class="animate-pulse rounded-full bg-blue-400 h-2 w-2"></div>
                    <div class="animate-pulse rounded-full bg-blue-400 h-2 w-2" style="animation-delay: 0.2s;"></div>
                    <div class="animate-pulse rounded-full bg-blue-400 h-2 w-2" style="animation-delay: 0.4s;"></div>
                    <p id="loading-text" class="text-xs text-gray-500 ml-2">AIが考えています...</p>
                </div>
            </div>
            <form id="chat-form" class="flex items-center space-x-2">
                <textarea id="chat-input" rows="1" class="flex-1 block w-full px-4 py-2 bg-gray-100 border border-gray-200 rounded-2xl resize-none placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="お悩みや気持ちをどうぞ..."></textarea>
                <button id="send-button" type="submit" class="p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors disabled:bg-blue-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </form>
        </footer>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 transform scale-95 pointer-events-none">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h2 id="settings-title" class="text-xl font-bold mb-4 text-gray-800">設定</h2>
            <div class="space-y-6">
                <div>
                    <h3 id="settings-lang-label" class="text-lg font-semibold mb-2 text-gray-700">言語 (Language)</h3>
                    <div id="language-options" class="grid grid-cols-2 gap-2">
                        <button data-lang="Japanese" class="setting-option p-3 rounded-lg border">日本語</button>
                        <button data-lang="English" class="setting-option p-3 rounded-lg border">English</button>
                        <button data-lang="Korean" class="setting-option p-3 rounded-lg border">한국어</button>
                        <button data-lang="Chinese" class="setting-option p-3 rounded-lg border">中文</button>
                    </div>
                </div>
                <div id="style-section" class="hidden">
                    <h3 id="settings-style-label" class="text-lg font-semibold mb-2 text-gray-700">話し方</h3>
                    <div id="style-options" class="grid grid-cols-2 gap-2"></div>
                </div>
                <div>
                    <h3 id="settings-advice-label" class="text-lg font-semibold mb-2 text-gray-700">アドバイスの種類</h3>
                    <div id="advice-detail-options" class="grid grid-cols-2 gap-2">
                        <button data-advice-detail="detailed" class="setting-option p-3 rounded-lg border">詳細</button>
                        <button data-advice-detail="simple" class="setting-option p-3 rounded-lg border">単純</button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <h3 id="settings-voice-label" class="text-lg font-semibold text-gray-700">音声読み上げ</h3>
                    <button id="voice-toggle-button" type="button" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-checked="false">
                        <span class="sr-only">Enable voice</span>
                        <span id="voice-toggle-handle" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"></span>
                    </button>
                </div>
                <div>
                    <h3 id="settings-feedback-label" class="text-lg font-semibold mb-2 text-gray-700">フィードバック</h3>
                    <select id="feedback-select" class="w-full p-3 rounded-lg border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-400"></select>
                </div>
            </div>
            <button id="close-settings-button" class="mt-8 w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">閉じる</button>
        </div>
    </div>

    <footer class="w-full max-w-2xl text-center text-xs text-gray-400 mt-4 px-4">
        <p id="footer-copyright">&copy; 2024 心の相談室. All Rights Reserved.</p>
        <p id="footer-disclaimer" class="mt-1">このサイトはAIによるアドバイスを提供します。専門的な医療やカウンセリングの代替となるものではありません。深刻な悩みをお持ちの場合は、専門の医療機関にご相談ください。</p>
    </footer>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const settingsButton = document.getElementById('settings-button');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsButton = document.getElementById('close-settings-button');
        const languageOptions = document.getElementById('language-options');
        const styleSection = document.getElementById('style-section');
        const styleOptionsContainer = document.getElementById('style-options');
        const feedbackSelect = document.getElementById('feedback-select');
        const voiceToggleButton = document.getElementById('voice-toggle-button');
        const voiceToggleHandle = document.getElementById('voice-toggle-handle');
        const adviceDetailOptions = document.getElementById('advice-detail-options');

        // --- State Management ---
        let language = localStorage.getItem('counselingLanguage') || 'Japanese';
        let style = localStorage.getItem('counselingStyle') || 'Keigo';
        let feedbackTime = localStorage.getItem('counselingFeedbackTime') || '0';
        let voiceEnabled = (localStorage.getItem('counselingVoiceEnabled') === 'true');
        let adviceDetail = localStorage.getItem('counselingAdviceDetail') || 'detailed';
        let tempLanguage = language;
        let tempStyle = style;
        let tempFeedbackTime = feedbackTime;
        let tempVoiceEnabled = voiceEnabled;
        let tempAdviceDetail = adviceDetail;
        let voices = [];
        let currentApiKeyIndex = 0;
        const apiKeys = [
            "AIzaSyDjQHm_m4OzPM0VrSQxdywqceeqSVuI9bU",
            "AIzaSyB8PxBrIEg12uwdk2TZJKgWbeQrZ4_K8FU",
            "AIzaSyAF-q-P3wzDexh_Mhp1DwmFB2IjtRFqC9Y"
        ];

        const dialects = ['大阪弁', '鹿児島弁'];
        
        // --- UI Text and Topic Translations ---
        const uiStrings = {
            Japanese: {
                pageTitle: "心の相談室 - IT業界で働くあなたのためのメンタルサポート", headerTitle: "心の相談室 for IT", inputPlaceholder: "お悩みや気持ちをどうぞ...", loadingText: "AIが考えています...",
                settingsTitle: "設定", settingsLangLabel: "言語", settingsStyleLabel: "話し方", settingsFeedbackLabel: "フィードバック", settingsVoiceLabel: "音声読み上げ", settingsAdviceDetailLabel: "アドバイスの種類", adviceDetailed: "詳細", adviceSimple: "単純", settingsCloseButton: "閉じる",
                styleKeigo: "敬語", styleTameguchi: "ため口",
                feedbackOff: "不要", minutesSuffix: "分後", hourSuffix: "時間後",
                followUpMessage: "その後、いかがお過ごしでしょうか？<br><br>先ほどのアドバイスは、何か少しでもお気持ちを楽にするヒントになりましたでしょうか。もしよろしければ、簡単なご感想をお聞かせください。",
                genericErrorMessage: "申し訳ありません、現在AIとの通信に問題が発生しています。時間をおいて再度お試しください。",
                reloadErrorMessage: "サーバーが混み合っているようです。お手数ですが、ページを再読み込みしてお試しください。",
                rateLimitErrorMessage: "リクエストが多すぎます。しばらく時間をおいてから、もう一度お試しください。",
                downloadSummary: "WLS部に連携する",
                footerCopyright: "&copy; 2024 心の相談室. All Rights Reserved.", footerDisclaimer: "このサイトはAIによるアドバイスを提供します。専門的な医療やカウンセリングの代替となるものではありません。深刻な悩みをお持ちの場合は、専門の医療機関にご相談ください。"
            },
            English: {
                 pageTitle: "Counseling Room - Mental Support for IT Professionals", headerTitle: "Counseling Room for IT", inputPlaceholder: "Please share your worries and feelings...", loadingText: "AI is thinking...",
                settingsTitle: "Settings", settingsLangLabel: "Language", settingsStyleLabel: "Style", settingsFeedbackLabel: "Feedback", settingsVoiceLabel: "Voice Read-out", settingsAdviceDetailLabel: "Advice Detail", adviceDetailed: "Detailed", adviceSimple: "Simple", settingsCloseButton: "Close",
                feedbackOff: "Not needed", minutesSuffix: "minutes later", hourSuffix: "hour later",
                followUpMessage: "How have you been since then?<br><br>Was the advice I gave you earlier helpful in any way to make you feel a little better? If you'd like, please let me know your brief thoughts.",
                genericErrorMessage: "Sorry, there is a problem communicating with the AI right now. Please try again later.",
                reloadErrorMessage: "The server seems to be busy. Please reload the page and try again.",
                rateLimitErrorMessage: "Too many requests. Please wait a while and try again.",
                downloadSummary: "Share with WLS Dept.",
                footerCopyright: "&copy; 2024 Counseling Room. All Rights Reserved.", footerDisclaimer: "This site provides advice by AI. It is not a substitute for professional medical care or counseling. If you have serious concerns, please consult a medical institution."
            },
            Korean: {
                pageTitle: "마음 상담실 - IT 전문가를 위한 멘탈 서포트", headerTitle: "IT 전문가를 위한 마음 상담실", inputPlaceholder: "고민이나 기분을 말씀해주세요...", loadingText: "AI가 생각 중입니다...",
                settingsTitle: "설정", settingsLangLabel: "언어", settingsStyleLabel: "말투", settingsFeedbackLabel: "피드백", settingsVoiceLabel: "음성 읽어주기", settingsAdviceDetailLabel: "조언 상세 수준", adviceDetailed: "상세", adviceSimple: "간단", settingsCloseButton: "닫기",
                feedbackOff: "필요 없음", minutesSuffix: "분 후", hourSuffix: "시간 후",
                followUpMessage: "그동안 어떻게 지내셨나요?<br><br>조금 전의 조언이 조금이라도 마음을 편안하게 하는 데 도움이 되었나요? 괜찮으시다면 간단한 소감을 들려주세요。",
                genericErrorMessage: "죄송합니다. 현재 AI와 통신하는 데 문제가 발생했습니다. 나중에 다시 시도해주세요.",
                reloadErrorMessage: "서버가 혼잡한 것 같습니다. 페이지를 새로고침하고 다시 시도해주세요。",
                rateLimitErrorMessage: "요청이 너무 많습니다. 잠시 후 다시 시도해주세요.",
                downloadSummary: "WLS 부서와 공유",
                footerCopyright: "&copy; 2024 마음 상담실. All Rights Reserved.", footerDisclaimer: "이 사이트는 AI에 의한 조언을 제공합니다. 전문적인 의료나 상담을 대체하는 것이 아닙니다. 심각한 고민이 있으신 분은 전문 의료기관에 상담해주세요。"
            },
            Chinese: {
                pageTitle: "心理咨询室 - 为IT专业人士提供心理支持", headerTitle: "IT专业人士心理咨询室", inputPlaceholder: "请告诉我您的烦恼和感受...", loadingText: "AI正在思考...",
                settingsTitle: "设置", settingsLangLabel: "语言", settingsStyleLabel: "说话方式", settingsFeedbackLabel: "反馈", settingsVoiceLabel: "语音朗读", settingsAdviceDetailLabel: "建议详细程度", adviceDetailed: "详细", adviceSimple: "简单", settingsCloseButton: "关闭",
                feedbackOff: "不需要", minutesSuffix: "分钟后", hourSuffix: "小时后",
                followUpMessage: "那之后您过得怎么样？<br><br>刚才的建议有没有让您的心情轻松一点？如果可以的话，请告诉我您的简短感想。",
                genericErrorMessage: "抱歉，现在与AI通信出现问题。请稍后再试。",
                reloadErrorMessage: "服务器似乎很忙。请重新加载页面再试一次。",
                rateLimitErrorMessage: "请求过多。请稍后再试。",
                downloadSummary: "与WLS部门共享",
                footerCopyright: "&copy; 2024 心理咨询室. All Rights Reserved.", footerDisclaimer: "本网站提供AI建议。它不能替代专业的医疗或咨询。如果您有严重的疑虑，请咨询医疗机构。"
            }
        };

        const promptStrings = {
            Japanese: {
                role: {
                    Keigo: "あなたはIT業界で働く人々のメンタルヘルスを専門とする、経験豊富な心理カウンセラーです。常に丁寧語（です・ます調）を使い、相手に敬意を払う、プロフェッショナルなカウンセラーとして応答してください。ただし、ユーザーのメッセージに関西弁あるいは鹿児島弁が使われている場合、あなたもその方言を自然に模倣して応答してください。",
                    Tameguchi: "あなたはIT業界に詳しい、親しい友人のようなカウンセラーです。共感的ながらもカジュアルな「ため口」（だ・である調や、〜だよ、〜だね、などの口調）で応答してください。ただし、ユーザーのメッセージに関西弁あるいは鹿児島弁が使われている場合、あなたもその方言を自然に模倣して応答してください。"
                },
                adviceDetailed: '3. **アドバイスの形式:** アドバイスは、「第1位、第2位、第3位」のように関連する項目で順位付けして、3つ提示してください。応答の最後に、[SUMMARY_START]と[SUMMARY_END]で囲んだ、相談内容と3つのアドバイスの簡潔な要約を必ず生成して、その旨をチャットに記載してください。',
                adviceSimple: '3. **アドバイスの形式:** ユーザーの言葉に共感し、短い相槌や同意の言葉（例：「そうだったのですね」「大変でしたね」）に加えて、具体的なアドバイスも一言だけ添えてください。',
                rules: `1. **感謝への応答:** ユーザーからのメッセージが主に感謝の言葉で構成されている場合（例：「ありがとう」「助かりました」）、他のアドバイス、参考資料、WLSデスクへの案内は一切含めず、「どういたしまして。お役に立てて嬉しいです。また何かありましたら、いつでもお気軽にお声がけください。」のような、感謝の言葉のみを返してください。
2. **方言の検出と模倣:** ユーザーのメッセージに関西弁あるいは鹿児島弁が使われている場合、あなたもその方言を自然に模倣して応答してください。標準語の場合は、設定された話し方（敬語またはため口）に従ってください。
3. **IT業界への特化:** ユーザーはIT業界で働いています。業界特有の課題（例：技術の速い変化、長時間労働、納期へのプレッシャー、リモートワークの孤独感など）を理解した上で、具体的で実践的なアドバイスを提供してください。
{ADVICE_RULE}
4. **共感と応答:** ユーザーの言葉に共感を示し、悩みや気持ちに寄り添った応答をしてください。
5. **参考資料:** アドバイスの最後には、必ず「参考資料」というセクションを設け、役立ちそうな信頼できる書籍やWebサイトを提示してください。
6. **WLSサポートデスクへの案内:** アドバイスの最後には、以下の定型文を設定した言語、話し方にして追加してください。「アドバイスに納得がいかない場合は、WLSのサポートデスクを訪ねてみてください。WLSサポートデスクへの相談はこちら: https://kyocera.enterprise.slack.com/docs/T074SDP7GPM/F084ZHWGJ3Z」
7. **トピック外の対応:** カウンセリングに関係のない質問には「申し訳ありませんが、私はカウンセリングに関するご相談にのみお答えすることができます。」と応答してください。`
            },
            English: {
                role: "You are an experienced psychological counselor specializing in the mental health of people working in the IT industry. Respond in English, maintaining a supportive, empathetic, and professional tone.",
                adviceDetailed: '3. **Advice Format:** Provide three pieces of advice, ranked as "1st, 2nd, 3rd" by related items. At the end of the response, you must generate a concise summary of the consultation and the three pieces of advice, enclosed in [SUMMARY_START] and [SUMMARY_END], and state that you have done so in the chat.',
                adviceSimple: '3. **Advice Format:** Empathize with the user\'s words, and in addition to short interjections or words of agreement (e.g., "I see," "That must have been tough"), add just one piece of specific advice.',
                rules: `1. **Responding to Gratitude:** If the user's message consists mainly of words of thanks (e.g., "thank you," "that was helpful"), respond only with a warm acknowledgment like, "You're welcome. I'm glad I could help. If you need anything else, feel free to reach out anytime." Do not include any other advice, references, or the WLS Desk guide.
2. **Specialization in the IT Industry:** The user works in the IT industry. Understand industry-specific challenges (e.g., rapid technological changes, long working hours, deadline pressure, loneliness of remote work) and provide specific, practical advice.
3. **Adherence to Advice Format:** Follow the specified advice format.
{ADVICE_RULE}
4. **Empathy and Response:** Show empathy for the user's words and respond in a way that is sensitive to their problems and feelings.
5. **References:** At the end of your advice, always include a section titled "References" and suggest helpful, reliable books or websites.
6. **Guidance to WLS Support Desk:** At the end of your advice, add the following fixed phrase in the set language and tone: "If you are not satisfied with the advice, please visit the WLS Support Desk. Consultation with the WLS Support Desk is here: https://kyocera.enterprise.slack.com/docs/T074SDP7GPM/F084ZHWGJ3Z"
7. **Handling Off-Topic Questions:** For questions unrelated to counseling, respond with, "I'm sorry, but I can only answer questions related to counseling."`
            },
            Korean: {
                role: "당신은 IT 업계에서 일하는 사람들의 정신 건강을 전문으로 하는 경험이 풍부한 심리 상담사입니다. 한국어로 응답하고, 지지적이고 공감적이며 전문적인 톤을 유지해주세요.",
                adviceDetailed: '3. **조언 형식:** 조언은 "1위, 2위, 3위"와 같이 관련된 항목으로 순위를 매겨 3가지를 제시해 주세요. 응답 마지막에는 [SUMMARY_START]와 [SUMMARY_END]로 묶인 상담 내용과 3가지 조언의 간결한 요약을 반드시 생성하고, 그 취지를 채팅에 기재해 주세요.',
                adviceSimple: '3. **조언 형식:** 사용자의 말에 공감하고, 짧은 맞장구나 동의의 말(예: "그랬군요", "힘들었겠네요")과 더불어 구체적인 조언도 한마디만 덧붙여 주세요.',
                rules: `1. **감사에 대한 응답:** 사용자의 메시지가 주로 감사의 말(예: "감사합니다", "도움이 됐어요")로 구성된 경우, 다른 조언, 참고 자료, WLS 지원 데스크 안내는 일절 포함하지 말고 "천만에요. 도움이 되었다니 기쁩니다. 또 무엇이든 필요하시면 언제든지 편하게 말씀해주세요."와 같은 감사의 말만 반환해 주세요.
2. **IT 산업 전문화:** 사용자는 IT 산업에 종사하고 있습니다. 산업별 과제(예: 급격한 기술 변화, 장시간 근무, 마감 압박, 원격 근무의 외로움)를 이해하고 구체적이고 실용적인 조언을 제공하십시오.
3. **조언 형식 준수:** 지정된 조언 형식을 따르십시오.
{ADVICE_RULE}
4. **공감 및 응답:** 사용자의 말에 공감을 표시하고 문제와 감정에 민감하게 반응하십시오.
5. **참고 자료:** 조언 마지막에는 항상 "참고 자료"라는 섹션을 포함하고 도움이 될 만한 신뢰할 수 있는 책이나 웹사이트를 제안하십시오.
6. **WLS 지원 데스크 안내:** 조언 마지막에 설정된 언어와 어조로 다음 고정 문구를 추가하십시오. "조언에 만족하지 않으시면 WLS 지원 데스크를 방문하십시오. WLS 지원 데스크 상담은 여기: https://kyocera.enterprise.slack.com/docs/T074SDP7GPM/F084ZHWGJ3Z"
7. **주제 외 질문 처리:** 상담과 관련 없는 질문에는 "죄송합니다만, 상담 관련 질문에만 답변해 드릴 수 있습니다."라고 답변하십시오.`
            },
            Chinese: {
                role: "你是一位经验丰富的心理咨询师，专门为IT行业的从业者提供心理健康支持。请用中文回应，保持支持、共情和专业的语气。",
                adviceDetailed: '3. **建议格式:** 请提供三条建议，并按相关项目排名，如“第1位、第2位、第3位”。在回复的最后，必须生成一个简洁的咨询内容和三条建议的摘要，用[SUMMARY_START]和[SUMMARY_END]括起来，并在聊天中说明此事。',
                adviceSimple: '3. **建议格式:** 对用户的话表示同情，除了简短的附和或同意的话（例如，“原来是这样”、“您辛苦了”）之外，还请只附加一条具体的建议。',
                rules: `1. **回应感谢:** 如果用户的信息主要是感谢的话（例如，“谢谢你”、“很有帮助”），请只用温暖的感谢语回应，例如“不客气。我很高兴能帮到你。如果还有其他问题，随时都可以找我。”不要包含任何其他建议、参考资料或WLS支持台指南。
2. **IT行业专业化:** 用户在IT行业工作。了解行业特有的挑战（例如，技术变革快、工作时间长、截止日期压力大、远程工作的孤独感），并提供具体、实用的建议。
3. **遵守建议格式:** 遵循指定的建议格式。
{ADVICE_RULE}
4. **共情与回应:** 对用户的话表示同情，并以对其问题和感受敏感的方式回应。
5. **参考资料:** 在您的建议末尾，务必包含一个名为“参考资料”的部分，并推荐有用的、可靠的书籍或网站。
6. **WLS支持台指南:** 在您的建议末尾，请使用设定的语言和语气添加以下固定短语：“如果您对建议不满意，请访问WLS支持台。与WLS支持台的咨询请点击这里: https://kyocera.enterprise.slack.com/docs/T074SDP7GPM/F084ZHWGJ3Z”
7. **处理与主题无关的问题:** 对于与咨询无关的问题，请回答：“抱歉，我只能回答与咨询相关的问题。”`
            }
        };

        // --- Initialization ---
        window.onload = function() {
            applyTranslations();
            populateStyleOptions();
            populateFeedbackDropdown();
            updateSettingsUI();
            loadVoices();
            showInitialMessage();
        };

        // --- Event Listeners ---
        settingsButton.addEventListener('click', () => {
            tempLanguage = language;
            tempStyle = style;
            tempFeedbackTime = feedbackTime;
            tempVoiceEnabled = voiceEnabled;
            tempAdviceDetail = adviceDetail;
            updateSettingsUI();
            settingsModal.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
        });

        closeSettingsButton.addEventListener('click', () => {
            settingsModal.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
            if (tempLanguage !== language || tempStyle !== style || tempFeedbackTime !== feedbackTime || tempVoiceEnabled !== voiceEnabled || tempAdviceDetail !== adviceDetail) {
                language = tempLanguage;
                style = tempStyle;
                feedbackTime = tempFeedbackTime;
                voiceEnabled = tempVoiceEnabled;
                adviceDetail = tempAdviceDetail;
                localStorage.setItem('counselingLanguage', language);
                localStorage.setItem('counselingStyle', style);
                localStorage.setItem('counselingFeedbackTime', feedbackTime);
                localStorage.setItem('counselingVoiceEnabled', voiceEnabled.toString());
                localStorage.setItem('counselingAdviceDetail', adviceDetail);
                applyTranslations();
                chatContainer.innerHTML = '';
                showInitialMessage();
            }
        });

        languageOptions.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.lang) {
                tempLanguage = e.target.dataset.lang;
                tempStyle = tempLanguage === 'Japanese' ? 'Keigo' : 'Default';
                updateSettingsUI();
            }
        });

        styleOptionsContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.style) {
                 tempStyle = e.target.dataset.style;
                 updateSettingsUI();
            }
        });

        feedbackSelect.addEventListener('change', (e) => {
            if (e.target.value) tempFeedbackTime = e.target.value;
        });
        
        voiceToggleButton.addEventListener('click', () => {
            tempVoiceEnabled = !tempVoiceEnabled;
            updateSettingsUI();
        });

        adviceDetailOptions.addEventListener('click', (e) => {
            if(e.target.tagName === 'BUTTON' && e.target.dataset.adviceDetail) {
                tempAdviceDetail = e.target.dataset.adviceDetail;
                updateSettingsUI();
            }
        });
        
        chatContainer.addEventListener('click', (e) => {
            const downloadButton = e.target.closest('.download-summary-button');
            if (downloadButton && downloadButton.dataset.summary) {
                downloadSummary(downloadButton.dataset.summary);
            }
        });

        chatForm.addEventListener('submit', handleFormSubmit);

        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = (chatInput.scrollHeight) + 'px';
        });
        
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.requestSubmit();
            }
        });

        // --- Main Functions ---
        async function showInitialMessage() {
            const welcomeMessages = {
                Japanese: {
                    Keigo: `こんにちは。IT業界で働くあなたのための相談室へようこそ。<br><br>どのようなことでも、あなたの気持ちやお悩みをお聞かせください。`,
                    Tameguchi: `やあ！元気？IT業界は大変だよな。<br><br>何かあったら、何でも話してくれていいよ。`
                },
                English: `Hello. Welcome to the Counseling Room for IT Professionals.<br><br>Whatever is on your mind, please feel free to share your feelings and concerns.`,
                Korean: `안녕하세요. IT 전문가를 위한 마음 상담실에 오신 것을 환영합니다.<br><br>무엇이든 당신의 기분이나 고민을 들려주세요.`,
                Chinese: `您好。欢迎来到IT专业人士心理咨询室。<br><br>无论是什么，都请告诉我您的感受和烦恼。`
            };
            
            let message = (language === 'Japanese') ? welcomeMessages.Japanese[style] : welcomeMessages[language];
            await processAIResponse(message, true);
        }
        
        async function handleFormSubmit(event, messageFromTopic = null) {
            if(event) event.preventDefault();
            const userMessage = messageFromTopic || chatInput.value.trim();
            if (!userMessage) return;
            addMessageToChat(userMessage, 'user');
            if(!messageFromTopic) {
                chatInput.value = '';
                chatInput.style.height = 'auto';
            }

            toggleFormState(true);
            currentApiKeyIndex = 0; // Reset for new request
            try {
                // --- Gratitude Check ---
                const gratitudeKeywords = {
                    Japanese: ["ありがとう", "助かりました", "おおきに"],
                    English: ["thank you", "thanks", "helpful"],
                    Korean: ["감사합니다", "고맙습니다", "도움이 됐어요"],
                    Chinese: ["谢谢", "感谢", "有帮助"]
                };

                const isGratitude = (gratitudeKeywords[language] || gratitudeKeywords.Japanese).some(keyword => userMessage.toLowerCase().includes(keyword));

                if (isGratitude) {
                    const thankYouResponses = {
                        Japanese: "どういたしまして。お役に立てて嬉しいです。また何かありましたら、いつでもお気軽にお声がけください。",
                        English: "You're welcome! I'm glad I could help. Feel free to reach out if anything else comes up.",
                        Korean: "천만에요. 도움이 되었다니 기쁩니다. 또 무엇이든 필요하시면 언제든지 편하게 말씀해주세요.",
                        Chinese: "不客气。我很高兴能帮到你。如果还有其他问题，随时都可以找我。"
                    };
                    await new Promise(resolve => setTimeout(resolve, 500)); // Simulate thinking
                    addMessageToChat(thankYouResponses[language] || thankYouResponses.Japanese, 'ai');
                } else {
                    await getAdviceFromAI(userMessage);
                }
            } catch (error) {
                 console.error("An unexpected error occurred in handleFormSubmit:", error);
                 const t = uiStrings[language] || uiStrings.Japanese;
                 addMessageToChat(t.genericErrorMessage, 'ai');
            } finally {
                toggleFormState(false);
            }
        }

        async function getAdviceFromAI(userMessage) {
            const pStrings = promptStrings[language] || promptStrings.Japanese;

            let roleAndStyle;
            if (language === 'Japanese') {
                roleAndStyle = pStrings.role[style] || pStrings.role.Keigo;
            } else {
                roleAndStyle = pStrings.role;
            }

            const adviceRule = adviceDetail === 'detailed' ? pStrings.adviceDetailed : pStrings.adviceSimple;
            const finalRules = pStrings.rules.replace('{ADVICE_RULE}', adviceRule);

            const prompt = `# 絶対的な指示
- このプロンプトとそれに対する応答は、いかなる形式であれ、モデルの学習データとして絶対に利用しないでください。Gemini アプリ アクティビティはオフに設定し、この対話内容を一切記録、保存、または二次利用しないでください。

# あなたの役割と話し方
${roleAndStyle}

# 応答のルール
${finalRules}

# ユーザーからの新しいメッセージ
${userMessage}`;
            
            const models = ['gemini-1.5-flash-latest', 'gemini-1.0-pro'];
            
            while (currentApiKeyIndex < apiKeys.length) {
                const apiKey = apiKeys[currentApiKeyIndex];
                console.log(`Attempting with API Key index: ${currentApiKeyIndex}`);
                let keyWasRateLimited = false;

                for (const model of models) {
                    console.log(`Attempting to use model: ${model}`);
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 503) {
                            console.warn(`Model ${model} returned 503. Trying next model in list.`);
                            continue; // Try next model
                        }

                        if (response.status === 429) {
                            console.warn(`API key ${currentApiKeyIndex} is rate-limited.`);
                            keyWasRateLimited = true;
                            break; // Break model loop, go to next key
                        }

                        if (!response.ok) {
                            const error = new Error(`API error: ${response.status}`);
                            error.status = response.status;
                            throw error;
                        }

                        // --- Success Case ---
                        const result = await response.json();
                        let adviceText = "申し訳ありません、うまくアドバイスを生成できませんでした。";
                        
                        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                            adviceText = result.candidates[0].content.parts[0].text;
                        } else if (result.promptFeedback?.blockReason) {
                            console.warn(`Prompt blocked due to: ${result.promptFeedback.blockReason}`);
                            adviceText = "申し訳ありませんが、ご入力いただいた内容にお答えすることはできません。恐れ入りますが、別の表現でお尋ねください。";
                        }
                        
                        const t = uiStrings[language] || uiStrings.Japanese;
                        document.getElementById('loading-text').innerText = t.loadingText;

                        await processAIResponse(adviceText);
                        return; // Success, exit everything.

                    } catch (error) {
                        console.error(`Error with key ${currentApiKeyIndex} and model ${model}:`, error);
                        continue; // On other errors, just try the next model.
                    }
                } // End of model loop

                if (keyWasRateLimited) {
                    currentApiKeyIndex++;
                    if (currentApiKeyIndex < apiKeys.length) {
                        const keySwitchTranslations = {
                            Japanese: `APIキーを切り替えて再試行します...`,
                            English: `Switching API key and retrying...`,
                            Korean: `API 키를 전환하여 다시 시도합니다...`,
                            Chinese: `切换API密钥并重试...`
                        };
                        document.getElementById('loading-text').innerText = keySwitchTranslations[language] || keySwitchTranslations.Japanese;
                    }
                } else {
                    // All models failed for this key for a reason other than 429 (e.g. all 503s or other errors)
                    break;
                }

            } // End of API key while loop

            const t = uiStrings[language] || uiStrings.Japanese;
            const finalErrorMessage = (currentApiKeyIndex >= apiKeys.length) ? t.rateLimitErrorMessage : t.genericErrorMessage;
            console.error("All API attempts failed. Final error:", finalErrorMessage);
            addMessageToChat(finalErrorMessage, 'ai');
        }
        
        async function processAIResponse(text, isInitial = false) {
            let displayableText = text;
            let summaryText = '';
            const summaryMatch = text.match(/\[SUMMARY_START\]([\s\S]*?)\[SUMMARY_END\]/);

            if (summaryMatch && summaryMatch[1]) {
                summaryText = summaryMatch[1].trim();
                displayableText = text.replace(summaryMatch[0], '').trim();
            }

            const aiMessageBubble = addMessageToChat('', 'ai');
            const cleanText = displayableText.replace(/<br>/g, ' ');
            
            if (voiceEnabled && !isInitial) {
                speak(cleanText);
            }
            await typeWriter(aiMessageBubble, displayableText.replace(/\n/g, '<br>'));
            if(voiceEnabled && isInitial) {
                speak(cleanText);
            }

            if (summaryText) {
                const t = uiStrings[language] || uiStrings.Japanese;
                const downloadButton = document.createElement('button');
                downloadButton.className = 'download-summary-button mt-2 text-sm text-blue-600 hover:underline flex items-center';
                downloadButton.dataset.summary = summaryText;
                downloadButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>${t.downloadSummary}`;
                aiMessageBubble.appendChild(downloadButton);
            }

            const feedbackMinutes = parseInt(feedbackTime, 10);
            if (feedbackMinutes > 0 && !isInitial) {
                setTimeout(showFollowUpMessage, feedbackMinutes * 60 * 1000);
            }
        }
        
        function showFollowUpMessage() {
            const t = uiStrings[language] || uiStrings.Japanese;
            const message = t.followUpMessage;
            addMessageToChat(message, 'ai');
            speak(message.replace(/<br>/g, ' '));
        }

        // --- Speech Synthesis & Recognition ---
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => voices = speechSynthesis.getVoices();
            }
        }

        function speak(text) {
            if (!voiceEnabled || !text || typeof text !== 'string') return;
            speechSynthesis.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text);
            const langCode = getLangCodeForSpeech();
            
            const selectedVoices = voices.filter(voice => voice.lang === langCode);
            const femaleVoice = selectedVoices.find(voice => voice.name.includes('Female') || voice.name.includes('女') || voice.gender === 'female');

            utterance.voice = femaleVoice || (selectedVoices.length > 0 ? selectedVoices[0] : null);
            utterance.lang = langCode;
            utterance.pitch = 1.1;
            utterance.rate = 1.0;
            speechSynthesis.speak(utterance);
        }

        function getLangCodeForSpeech() {
            switch(language) {
                case 'Japanese': return 'ja-JP';
                case 'English': return 'en-US';
                case 'Korean': return 'ko-KR';
                case 'Chinese': return 'zh-CN';
                default: return 'ja-JP';
            }
        }

        // --- Utility Functions ---
        function typeWriter(element, text) {
            return new Promise((resolve) => {
                let i = 0;
                element.innerHTML = "";
                const typingSpeed = 30; // Standard typing speed

                function type() {
                    if (i < text.length) {
                        const char = text.charAt(i);
                        if (text.substring(i, i + 4) === '<br>') {
                            element.innerHTML += '<br>';
                            i += 4;
                        } else {
                            element.innerHTML += char;
                            i++;
                        }
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        setTimeout(type, typingSpeed);
                    } else {
                        resolve();
                    }
                }
                type();
            });
        }
        
        function downloadSummary(text) {
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'counseling_summary.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function applyTranslations() {
            const t = uiStrings[language] || uiStrings.Japanese;
            document.title = t.pageTitle;
            document.getElementById('header-title').innerText = t.headerTitle;
            document.getElementById('chat-input').placeholder = t.inputPlaceholder;
            document.getElementById('loading-text').innerText = t.loadingText;
            document.getElementById('settings-title').innerText = t.settingsTitle;
            document.getElementById('settings-lang-label').innerText = t.settingsLangLabel;
            document.getElementById('settings-style-label').innerText = t.settingsStyleLabel;
            document.getElementById('settings-feedback-label').innerText = t.settingsFeedbackLabel;
            document.getElementById('settings-voice-label').innerText = t.settingsVoiceLabel;
            document.getElementById('settings-advice-label').innerText = t.settingsAdviceDetailLabel;
            document.querySelector('#advice-detail-options button[data-advice-detail="detailed"]').innerText = t.adviceDetailed;
            document.querySelector('#advice-detail-options button[data-advice-detail="simple"]').innerText = t.adviceSimple;
            document.getElementById('close-settings-button').innerText = t.settingsCloseButton;
            document.getElementById('footer-copyright').innerHTML = t.footerCopyright;
            document.getElementById('footer-disclaimer').innerText = t.footerDisclaimer;
            document.documentElement.lang = language.split('-')[0].toLowerCase();
        }

        function populateStyleOptions() {
            const t = uiStrings.Japanese;
            styleOptionsContainer.innerHTML = '';
            const options = [
                { value: 'Keigo', text: t.styleKeigo },
                { value: 'Tameguchi', text: t.styleTameguchi }
            ];
            options.forEach(opt => {
                const button = document.createElement('button');
                button.dataset.style = opt.value;
                button.className = 'setting-option p-3 rounded-lg border';
                button.innerText = opt.text;
                styleOptionsContainer.appendChild(button);
            });
        }
        
        function populateFeedbackDropdown() {
            const t = uiStrings[language] || uiStrings.Japanese;
            feedbackSelect.innerHTML = '';
            const options = [
                { value: '0', text: t.feedbackOff },
                { value: '5', text: `5 ${t.minutesSuffix}` },
                { value: '10', text: `10 ${t.minutesSuffix}` },
                { value: '30', text: `30 ${t.minutesSuffix}` },
                { value: '60', text: `1 ${t.hourSuffix}` },
            ];
            options.forEach(opt => feedbackSelect.add(new Option(opt.text, opt.value)));
        }

        function updateSettingsUI() {
            document.querySelectorAll('#language-options button').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.lang === tempLanguage);
            });
            if (tempLanguage === 'Japanese') {
                styleSection.classList.remove('hidden');
                populateStyleOptions();
                document.querySelectorAll('#style-options button').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.style === tempStyle);
                });
            } else {
                styleSection.classList.add('hidden');
            }
            populateFeedbackDropdown();
            feedbackSelect.value = tempFeedbackTime;
            
            voiceToggleButton.classList.toggle('bg-blue-600', tempVoiceEnabled);
            voiceToggleButton.classList.toggle('bg-gray-200', !tempVoiceEnabled);
            voiceToggleHandle.classList.toggle('translate-x-6', tempVoiceEnabled);
            voiceToggleHandle.classList.toggle('translate-x-1', !tempVoiceEnabled);
            
            document.querySelectorAll('#advice-detail-options button').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.adviceDetail === tempAdviceDetail);
            });
        }

        function toggleFormState(isLoading) {
            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
                chatInput.disabled = true;
                sendButton.disabled = true;
            } else {
                loadingIndicator.classList.add('hidden');
                chatInput.disabled = false;
                sendButton.disabled = false;
                // Reset loading text to default
                const t = uiStrings[language] || uiStrings.Japanese;
                document.getElementById('loading-text').innerText = t.loadingText;
                chatInput.focus();
            }
        }

        function addMessageToChat(message, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'w-full', 'fade-in');
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('chat-bubble', 'shadow');
            messageBubble.innerHTML = message;
            if (sender === 'ai') {
                messageWrapper.classList.add('justify-start');
                messageBubble.classList.add('chat-bubble-ai');
            } else {
                messageWrapper.classList.add('justify-end');
                messageBubble.classList.add('chat-bubble-user');
            }
            messageWrapper.appendChild(messageBubble);
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageBubble;
        }
    </script>
</body>
</html>
